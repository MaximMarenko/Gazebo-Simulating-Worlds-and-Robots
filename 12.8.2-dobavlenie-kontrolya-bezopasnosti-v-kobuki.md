# 12.8.2 Добавление контроля безопасности в Kobuki

Раздел _/mobile\_base/command/velocity_ обеспечивает прямой контроль над движением робота, игнорируя при этом любые данные, поступающие от датчиков обрыва или удара. Например, вы можете захотеть, чтобы робот толкнул коробку по полу, и в этом случае мы не хотим, чтобы нажатие на датчик удара останавливало робота. Но ROS-программисты компании Yujin Robot создали еще один механизм управления, который автоматически сделает все возможное, чтобы робот не навредил ни себе, ни другим.

Контроллер [kobuki\_safety\_controller](http://wiki.ros.org/kobuki_safety_controller) отслеживает события с датчика обрыва, удара и датчиков отказа колес Kobuki и публикует соответствующее сообщение в отчете, если какой-нибудь из этих датчиков укажет на неисправность. В случае датчиков обрыва и удара контроллер заставляет робота останавливаться и выполнять резервное копирование, в то время как датчик отказа колес просто заставляет робота останавливаться.

Контроллер безопасности работает с узлом [yocs\_cmd\_vel\_mux](http://wiki.ros.org/yocs_cmd_vel_mux), который мы рассмотрели в главе 8. Этот узел может быть легко настроен на то, чтобы дать контроллеру безопасности приоритет над всеми другими командами скорости из других источников, таких как навигационный стек \(move\_base\), teleop node или командная строка.

Чтобы увидеть контроллер безопасности в действии, сначала завершите все команды публикации значений скоростей, которые могли быть запущены из предыдущего раздела. Затем сбросьте тестовую настройку в Gazebo, щелкнув меню Edit \(Правка\) и выбрав Reset Model Poses \(Сбросить позиции модели\).

На этот раз, вместо публикации данных скорости непосредственно из командной строки, воспользуемся графическим интерфейсом ArbotiX, который публикует сообщения Twist в стандартной теме /cmd\_vel, как и в предыдущих примерах из командной строки:

```text
$ arbotix_gui
```

Вы должны увидеть управление трекпадом, как показано на рисунке снизу. Обратите внимание, что в данный момент вы не сможете управлять Kobuki с помощью трекпада, потому что arbotix\_gui публикует сообщения Twist в теме /cmd\_vel, в то время как имитируемый Kobuki будет слушать команды в разделе /mobile\_base/commands/velocity.

![](.gitbook/assets/image%20%281%29.png)

Теперь запустите контроллер безопасности Kobuki и _CmdVelMuxNodelet_ используя следующий файл запуска:

```text
$ roslaunch rbx2_gazebo kobuki_yocs_safety_controller.launch
```

Данный файл запуска загружает конфигурационный файл yocs\_safety\_mux.yaml из директории rbx2\_gazebo/config. Этот файл имеет ту же базовую структуру, что и конфигурационные файлы, которые мы использовали в Гл. 8, и показан ниже:

```text
subscribers:
- name:             "Safe reactive
controller"     topic:
"safety_controller"     timeout:     0.2
priority:     2

-     name:         "Joystick control"
topic:         "/joystick_cmd_vel"
    timeout:                 0.2
priority:     1

-     name:         "Any node that publishes
directly to /cmd_vel"
    topic:         "/cmd_vel"
timeout:     0.2
priority:     0

publisher:         "output/cmd_vel"
```

Обратите внимание на то, что мы присвоили контроллеру безопасности высший приоритет, за которым следует joystick node, который публикуется в разделе /joystick\_cmd\_vel, как мы делали это в Главе 8, а затем любой другой узел, который публикуется в стандартном разделе /cmd\_vel. Так как arbotix\_gui узел публикуется в /cmd\_vel, теперь вы должны быть в состоянии управлять роботом с помощью функции трекпад; однако, вы не сможете сдвинуть робота со стола, так как датчики обрыва предупреждают контроллер безопасности, который, в свою очередь, переопределяет входные данные с трекпада. Попробуйте! \(Просто не двигайте робота задом наперёд, так как у него только спереди датчики обрыва\). Вы также можете попробовать врезаться в шлакоблок и вы в таком случае должны увидеть, что контроллер безопасности заставляет робота "отскакивать", создавая ему резервную копию a после удара.

Если у вас есть джойстик, вы также можете добавить его, запустив файл запуска:

```text
$ roslaunch rbx2_nav mux_joystick_teleop.launch
```

Теперь управляйте роботом с помощью джойстика и понаблюдайте за тем, как контроллер безопасности защищает вас от неприятностей.

